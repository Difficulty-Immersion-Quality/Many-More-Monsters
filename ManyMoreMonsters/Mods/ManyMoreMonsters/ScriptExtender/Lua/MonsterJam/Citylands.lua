--CTY_Main_A
--Why did I make so many things oh god
local Null = "NULL_00000000-0000-0000-0000-000000000000"
local Act3Mimic = "MMM_ACT3MIMIC_c3a019a8-bbae-4591-ad10-0f45580be467"
local Adam3b = "MMM_THIEFTRIO3B_6d0c7554-12aa-4f16-bb96-78dff9ca6709"
local Liam3b = "MMM_THIEFTRIO3B_f420416e-edf0-46fe-98dc-0984574dd1bb"
local Mike3b = "MMM_THIEFTRIO3B_ec5ff08f-47b0-4706-8d20-9c73709bd5c3"
local Adam3j = "MMM_THIEFTRIO3J_0f33779b-7c84-48f1-aa29-0a574463f81a"
local Liam3j = "MMM_THIEFTRIO3J_f9b0c0c8-a916-4a9a-9cf8-63754a60fda7"
local Mike3j = "MMM_THIEFTRIO3J_15820d6d-6637-467d-850b-c13cc00fd654"



--Mimic Chests
local Act3BChest1 = "MMM_ACT3BCHEST_5adb8ba4-48c2-4b99-a10e-75832ca94dae"
local Act3BChest2 = "MMM_ACT3BCHEST_ca61ec9a-b78d-4e07-b3e6-745449a10e81"
local Act3BChest3 = "MMM_ACT3BCHEST_0342ae23-252e-4238-9efb-9088d2fad031"
local Act3BChest4 = "MMM_ACT3BCHEST_641283e8-bb0f-4bcb-bc6d-8c96da4f8596"
local Act3BChest5 = "MMM_ACT3BCHEST_022345f9-7f21-472b-9cd8-41b46c327291"
local Act3BChest6 = "MMM_ACT3BCHEST_58c38d01-6e0b-44f0-882a-063b1f116fd0"
local Act3BChest7 = "MMM_ACT3BCHEST_4686c2ac-42b6-4cb2-ae5c-125fad3efba9"
local Act3BChest8 = "MMM_ACT3BCHEST_eab4bbd8-cba4-472e-b578-42da33922578"
local Act3BChest9 = "MMM_ACT3BCHEST_06f881be-083d-4bf1-882b-a3df31d63c25"
local Act3BChest10 = "MMM_ACT3BCHEST_672c0869-fc0b-4b84-bd9e-a356c3dd2bcd"
local Act3BChest11 = "MMM_ACT3BCHEST_c63d0e70-21f8-4a84-b9f0-abd97470b07c"
local Act3BChest12 = "MMM_ACT3BCHEST_f3cba79b-541c-454d-8f1a-7c2deaf72fab"
local Act3BChest13 = "MMM_ACT3BCHEST_5cec3081-ad12-43d2-9a82-cacc37a18528"
local Act3BChest14 = "MMM_ACT3BCHEST_da01fc10-df4c-45c1-8cc4-f3e1717fe98d"
local Act3BChest15 = "MMM_ACT3BCHEST_9cedcedb-0b4e-4be9-a884-323d9b074354"
local Act3BChest16 = "MMM_ACT3BCHEST_fc0627a9-f449-43cf-ac41-100cf52d0be7"
local Act3BChest17 = "MMM_ACT3BCHEST_c6e6bca1-fb2a-416a-b896-40eaa18c05e9"
local Act3BChest18 = "MMM_ACT3BCHEST_5e258802-dcdc-4d6a-af41-dbf0ef2d08a3"
local Act3BChest19 = "MMM_ACT3BCHEST_9446674c-75fd-4fdc-a37a-74e1da4b3e13"
local Act3BChest20 = "MMM_ACT3BCHEST_cdde16d3-ccca-4fdf-8909-cc2ce9a58b90"
local Act3BChest21 = "MMM_ACT3BCHEST_0e4766df-f66a-4809-afde-6f0353f9ea2d"
local Act3BChest22 = "MMM_ACT3BCHEST_241c8f4a-c774-4685-be0d-45dea19da3df"
local Act3BChest23 = "MMM_ACT3BCHEST_ac0ddcbc-080e-4f8c-85ae-c2f55bee5291"
local Act3BChest24 = "MMM_ACT3BCHEST_ef30068d-4df3-4621-9a3a-36aeac847203"
local Act3BChest25 = "MMM_ACT3BCHEST_2f210f8d-e8bd-4dd4-881e-7f2a2b820cf6"
local Act3BChest26 = "MMM_ACT3BCHEST_bb8316c7-1b26-4555-9d52-bd4687de6172"
local Act3BChest27 = "MMM_ACT3BCHEST_"
local Act3BChest28 = "MMM_ACT3BCHEST_"
local Act3BChest29 = "MMM_ACT3BCHEST_"
local Act3BChest30 = "MMM_ACT3BCHEST_"

--Factions
local FAbsoluteUndead = "60749034-59cb-4551-b5ea-07d1edd617a9"
local FOrpheusGish = "ACT2B_INT_Orpheus_ad62a159-c6fb-43ae-a682-63c139905874"
local FNeutral = "cfb709b3-220f-9682-bcfb-6f0d8837462e"
local FPlayer = "Hero_Player1_6545a015-1b3d-66a4-6a0e-6ec62065cdb7"
local FEvil = "Evil_NPC_64321d50-d516-b1b2-cfac-2eb773de1ff6"

--Item List
local PrisonDoor = "DOOR_Single_Prison_Grating_Iron_A_002_6e75b249-1d4b-43e9-8672-ac854c9fed45"

--Flags
local InitiateAct3B = "MMM_Act3b_Initiate_3cf6df1d-4408-49f8-b991-f85e16f9b0a3"
local Act3BMimicFlag = "MMM_Act3B_Mimics_4b0dc035-7f21-4432-a9ba-36e1897a758c"
local Act3AdamFlag = "MMM_Act3_Adam_5c52b843-5241-45bc-b1fb-01c01a36abe9"
local Act3LiamFlag = "MMM_Act3_Liam_a91c83b9-f510-44cc-b851-ac303e8ed86b"
local Act3MikeFlag = "MMM_Act3_Mike_73c1a7d3-f348-43e8-b689-7f17abb1b05a"
local Act3TrajectileBoss = "MMM_Act3_TrajectileBoss_a0236dd5-ef47-4600-b988-d785c4cb056f"
local Act3TrajectileJail = "MMM_Act3_TrajectileJail_75220041-b369-468a-a488-7fc3919dd231"


--On Load
local function InitiateMonstersCitylands()
end

local function ModifyMonstersCity()
    if Osi.GetFlag(Act3AdamFlag, Null) == 1 and
    Osi.GetFlag(Act3MikeFlag, Null) == 1 and
    Osi.GetFlag(Act3LiamFlag, Null) == 1 and
    Osi.GetFlag(Act3TrajectileBoss, Null) == 0 then
        Osi.SetOnStage(Adam3b, 1)
        Osi.SetOnStage(Mike3b, 1)
        Osi.SetOnStage(Liam3b, 1)
    else
        Osi.SetOnStage(Adam3b, 0)
        Osi.SetOnStage(Mike3b, 0)
        Osi.SetOnStage(Liam3b, 0)
    end
    if Osi.GetFlag(Act3TrajectileBoss, Null) == 1 and
        Osi.GetFlag(Act3TrajectileJail, Null) == 0 then
        Osi.SetOnStage(Adam3j, 1)
        Osi.SetOnStage(Mike3j, 1)
        Osi.SetOnStage(Liam3j, 1)
    else
        Osi.SetOnStage(Adam3j, 0)
        Osi.SetOnStage(Mike3j, 0)
        Osi.SetOnStage(Liam3j, 0)
    end
end

--Create Mimics
local function CreateAct3BMimics()
    local Act3BChestList = { Act3BChest1, Act3BChest2, Act3BChest3, Act3BChest4, Act3BChest5, Act3BChest6, Act3BChest7, Act3BChest8, Act3BChest9, Act3BChest10,
                            Act3BChest11, Act3BChest12, Act3BChest13, Act3BChest14, Act3BChest15, Act3BChest16, Act3BChest17, Act3BChest18, Act3BChest19, Act3BChest20,
                            Act3BChest21, Act3BChest22, Act3BChest23, Act3BChest24, Act3BChest25, Act3BChest26, Act3BChest27, Act3BChest28, Act3BChest29, Act3BChest30 }
    for _,PossibleMimic in ipairs(Act3BChestList) do
    local IsItAMimic = Ext.Utils.Random(1,5)
        if IsItAMimic == 1 then
            print("Mimic")
            Osi.ApplyStatus(PossibleMimic, "MMM_MIMIC3B", -1, 1, PossibleMimic)
        elseif IsItAMimic == 2 then
            print("Not a mimic, chest not hidden")
        elseif IsItAMimic == 3 then
            print("Not a mimic, chest not hidden")
        elseif IsItAMimic == 4 then
            print("Not a mimic, chest hidden")
            Osi.SetOnStage(PossibleMimic, 0)
        elseif IsItAMimic == 5 then
            print("Not a mimic, chest hidden")
            Osi.SetOnStage(PossibleMimic, 0)
        end
    end
end

function TurnIntoMimic3B(item, character)
    if Osi.IsDead(item) == 1 then
        return
    end
    local x,y,z = Osi.GetPosition(item)
    local MimicSpawnID = Osi.CreateAt(Act3Mimic, x, y, z, 0, 1, '')
    if MimicSpawnID then
        if (Osi.HasActiveStatus(character,"AMBUSH_IMMUNITY") == 1 or Osi.HasPassive(character, "Alert") == 1 or Osi.HasPassive(character, "Surprise_Immunity") == 1) and Osi.IsPlayer(character) == 1 then
            Osi.QRY_StartDialogCustom_Fixed("GLO_PAD_Mimic_Revealed_55471c86-3b69-ccae-d0e3-e8749cf41d9e", character, Null, Null, Null, Null, Null, 1, 1, -1, 1 )
        elseif Osi.HasActiveStatus(character,"AMBUSH_IMMUNITY") ~= 1 and Osi.HasPassive(character, "Alert") ~= 1 and Osi.HasPassive(character, "Surprise_Immunity") ~= 1 and Osi.IsPlayer(character) == 1 then
            Osi.QRY_StartDialogCustom_Fixed("GLO_PAD_Mimic_Surprised_cb5f94c8-ee5b-c17a-959c-64bc6f88b417", character, Null, Null, Null, Null, Null, 1, 1, -1, 1 )
        end
        Osi.MoveAllItemsTo(item, MimicSpawnID, 0, 0, 1)
    end
    Osi.SetOnStage(item, 0)
end

--Team Trajectile Boss
local function TeamTrajectileBoss()
    Osi.ApplyStatus(Mike3b, "MMM_TRAJECTILEBOSSSPEAK", 6, 1, "")
    Ext.Timer.WaitFor(1500, function()
        Osi.ApplyStatus(Liam3b, "MMM_TRAJECTILEBOSSSPEAK2", 6, 1, "")
        Ext.Timer.WaitFor(1000, function()
            Osi.ApplyStatus(Adam3b, "MMM_TEAMTRAJECTILEBLASTOFF", -1, 1, "")
            Osi.ApplyStatus(Liam3b, "MMM_TEAMTRAJECTILEBLASTOFF", -1, 1, "")
            Osi.ApplyStatus(Mike3b, "MMM_TEAMTRAJECTILEBLASTOFF", -1, 1, "")
        end)
    end)
end

local function TeamTrajectileLoss()
    Osi.ApplyStatus(Mike3b, "MMM_TRAJECTILEBOSSSPEAK3", 6, 1, "")
    Ext.Timer.WaitFor(3200, function()
        Osi.UseSpellAtPosition(Adam3b, "MMM_Shout_MassDimensionDoor", -1.0690089464188, 24.9501953125, 777.80303955078, 1)
        Osi.UseSpellAtPosition(Liam3b, "MMM_Shout_MassDimensionDoor", -1.0690089464188, 24.9501953125, 777.80303955078, 1)
        Osi.UseSpellAtPosition(Mike3b, "MMM_Shout_MassDimensionDoor", -1.0690089464188, 24.9501953125, 777.80303955078, 1)
        Ext.Timer.WaitFor(1200, function()
            Osi.SetOnStage(Adam3b, 0)
            Osi.SetOnStage(Liam3b, 0)
            Osi.SetOnStage(Mike3b, 0)
            Osi.SetFlag(Act3TrajectileBoss, Null, 0, 1)
            Osi.SetOnStage(Adam3j, 1)
            Osi.SetOnStage(Liam3j, 1)
            Osi.SetOnStage(Mike3j, 1)
            Osi.Close(PrisonDoor)
            Osi.Lock(PrisonDoor, "")
        end)
    end)
end

--Prison Break
local function PrisonBreak()
    Osi.ApplyStatus(Liam3j, "MMM_TRAJECTILEJAILSPEAK2", 6, 1, "")
    Osi.SetFlag(Act3TrajectileJail, Null, 0, 1)
    Ext.Timer.WaitFor(500, function()
        Osi.CharacterMoveToPosition(Adam3j, -1256.0815429688, 5.4235373681877, 742.35620117188, "Sprint", "", 0)
        Osi.CharacterMoveToPosition(Liam3j, -1256.0815429688, 5.4235373681877, 742.35620117188, "Sprint", "", 0)
        Ext.Timer.WaitFor(2000, function()
            Osi.ApplyStatus(Mike3j, "MMM_TRAJECTILEJAILSPEAK3", 6, 1, "")
            Osi.CharacterMoveToPosition(Mike3j, -1256.0815429688, 5.4235373681877, 742.35620117188, "Sprint", "", 0)
            Ext.Timer.WaitFor(4000, function()
                Osi.SetOnStage(Adam3j, 0)
                Osi.SetOnStage(Liam3j, 0)
                Osi.SetOnStage(Mike3j, 0)
            end)
        end)
    end)
end

Ext.Events.SessionLoaded:Subscribe(function()
end)

--Prepared Boost
Ext.Events.SessionLoaded:Subscribe(function()
    PrepareDuration = 0
end)

local function PreparedBoost()
    for i,v in ipairs(Ext.Entity.GetAllEntitiesWithComponent("ServerCharacter")) do
        local charIDprepared = v.Uuid.EntityUuid
        if Osi.IsTagged(charIDprepared, "25bf5042-5bf6-4360-8df8-ab107ccb0d37") == 1 then
            Osi.ApplyStatus(charIDprepared, "MMM_PREPARED", PrepareDuration, 1, charIDprepared)
        end
    end
end

---------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------
-------------------------------------------LISTENERS-----------------------------------------------------
---------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------

--What to run on loading level
Ext.Osiris.RegisterListener("LevelGameplayStarted", 2, "after", function(level_name, is_editor_mode)
    if (level_name ~= "CTY_Main_A") then 
        return 
    end
    if Osi.GetFlag(Act3BMimicFlag, Null) == 0 then
        Osi.SetFlag(Act3BMimicFlag, Null, 0, 1)
        CreateAct3BMimics()
    end
    if Osi.GetFlag(InitiateAct3B, Null) == 0 then
        Osi.SetFlag(InitiateAct3B, Null, 0, 1)
        InitiateMonstersCitylands()
    end
    ModifyMonstersCity()
end)

--Enter Combat Listener
Ext.Osiris.RegisterListener("EnteredCombat", 2, "after", function (object, combatGuid)
end)

--Turn started listener
Ext.Osiris.RegisterListener("TurnStarted", 1, "before", function(object)
    if object == Adam3b and Osi.GetHitpoints(Adam3b) <= 50 and Osi.GetFlag(Act3TrajectileBoss, Null) == 0 then
        TeamTrajectileLoss()
    end
    if object == Liam3b and Osi.GetHitpoints(Liam3b) <= 50 and Osi.GetFlag(Act3TrajectileBoss, Null) == 0 then
        TeamTrajectileLoss()
    end
    if object == Mike3b and Osi.GetHitpoints(Mike3b) <= 50 and Osi.GetFlag(Act3TrajectileBoss, Null) == 0 then
        TeamTrajectileLoss()
    end
end)

--Osi.AttackedBy
Ext.Osiris.RegisterListener("AttackedBy", 7, "after", function(defender, attackerOwner, attacker2, damageType, damageAmount, damageCause, storyActionID)
end)

--Death listener
Ext.Osiris.RegisterListener("Died", 1, "after", function(character)
end)

--End Combat Listener
Ext.Osiris.RegisterListener("CombatEnded", 1, "after", function(combatGuid)
end)

--Open item listener
Ext.Osiris.RegisterListener("Opened", 1, "before", function(item)
    if item == PrisonDoor and Osi.GetFlag(Act3TrajectileJail, Null) == 0 then
        PrisonBreak()
    end
end)

--Use item listener
Ext.Osiris.RegisterListener("UseStarted", 2, "after", function(character, item)
    if Osi.HasActiveStatus(item, "MMM_MIMIC3B") == 1 then
        TurnIntoMimic2(item, character)
    end
end)

--Dialog Start Request listener
Ext.Osiris.RegisterListener("DialogStartRequested", 2, "after", function(target, player)  
end)

--Destroy object listener
Ext.Osiris.RegisterListener("DestroyedBy", 4, "before", function(item, destroyer, destroyerOwner, storyActionID)
    if Osi.HasActiveStatus(item, "MMM_MIMIC3B") == 1 then
        TurnIntoMimic2(item, character)
    end
end)

--Added To listener
Ext.Osiris.RegisterListener("AddedTo", 3, "after", function(object, inventoryHolder, addType)
end)

--Saw something listener
Ext.Osiris.RegisterListener("Saw", 3, "after", function(character, targetcharacter, targetwassneaking)
end)

--Status Applied listener
Ext.Osiris.RegisterListener("StatusApplied", 4, "before", function(object, status, cause, storyActionID)
    if status == "MMM_THIEFTRIOBOSSATTACK" and
    Osi.IsTagged(object, "25bf5042-5bf6-4360-8df8-ab107ccb0d37") == 1 then
        TeamTrajectileBoss()
    end
    if status == "MMM_THIEFTRIOJAILATTACK" and Osi.IsTagged(object, "25bf5042-5bf6-4360-8df8-ab107ccb0d37") == 1 and Osi.GetFlag(Act3TrajectileJail, Null) == 0 then
        Osi.ApplyStatus(Adam3j, "MMM_TRAJECTILEJAILSPEAK", 6, 1, "")
    end
end)

--Roll listener
Ext.Osiris.RegisterListener("RollResult", 6, "after", function(eventName, roller, rollsubject, resultType, isActiveRoll, criticality)
end)

--Flag listener
Ext.Osiris.RegisterListener("FlagSet", 3, "after", function(flag, speaker, dialogInstance)
end)

--Event listener
Ext.Osiris.RegisterListener("EntityEvent", 2, "before", function(object, event)
end)